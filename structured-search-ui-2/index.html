<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.5 'Lora',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Lora',serif;font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:'Lora',serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:'Lora',serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:'Lora',serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:'Lora',serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:'Lora',serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:'Lora',serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}ul{margin-left:1.5rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.5rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:0.85rem;line-height:1.5rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:1rem;line-height:1.5rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}blockquote{margin-left:1.5rem;margin-right:1.5rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.5rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.5rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.5rem;margin-bottom:calc(1.5rem / 2);margin-top:calc(1.5rem / 2);}li > ul{margin-left:1.5rem;margin-bottom:calc(1.5rem / 2);margin-top:calc(1.5rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.5rem / 2);}code{font-size:0.85rem;line-height:1.5rem;}kbd{font-size:0.85rem;line-height:1.5rem;}samp{font-size:0.85rem;line-height:1.5rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1rem;padding-right:1rem;padding-top:0.75rem;padding-bottom:calc(0.75rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}</style><meta name="generator" content="Gatsby 5.14.1"/><meta name="theme-color" content="#663399"/><meta data-react-helmet="true" name="description" content="In which we write the grammar for the query language that will power our fancy UI"/><meta data-react-helmet="true" property="og:title" content="Structured search queries for web UIs, part 2: the grammar"/><meta data-react-helmet="true" property="og:description" content="In which we write the grammar for the query language that will power our fancy UI"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Jonathon Herbert"/><meta data-react-helmet="true" name="twitter:title" content="Structured search queries for web UIs, part 2: the grammar"/><meta data-react-helmet="true" name="twitter:description" content="In which we write the grammar for the query language that will power our fancy UI"/><style data-href="/styles.8f8c31ec70b3fda1fd3c.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Patua One;font-style:normal;font-weight:400;src:local("Patua One Regular "),local("Patua One-Regular"),url(/static/patua-one-latin-400-04538b4949ee084d70b5a5f22c16097b.woff2) format("woff2"),url(/static/patua-one-latin-400-944b1f7fff7ece8f6d5f84414536a6a3.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:normal;font-weight:300;src:local("Open Sans Light "),local("Open Sans-Light"),url(/static/open-sans-latin-300-b871ad6e5cbe2a1c8c7362c81a234f93.woff2) format("woff2"),url(/static/open-sans-latin-300-38bcfba2c37aac23453faf21d14511fb.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:italic;font-weight:300;src:local("Open Sans Light italic"),local("Open Sans-Lightitalic"),url(/static/open-sans-latin-300italic-b45d9997b704ab3daad1b5624eec1ad1.woff2) format("woff2"),url(/static/open-sans-latin-300italic-3ab0502d6136886180cdae3e714e30a3.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:normal;font-weight:400;src:local("Open Sans Regular "),local("Open Sans-Regular"),url(/static/open-sans-latin-400-f57a62e9efddf6ace18b15572f81905b.woff2) format("woff2"),url(/static/open-sans-latin-400-347639ec49f4b2884a9657afded83ace.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:italic;font-weight:400;src:local("Open Sans Regular italic"),local("Open Sans-Regularitalic"),url(/static/open-sans-latin-400italic-bb915319f59c02c348a615ad483772e7.woff2) format("woff2"),url(/static/open-sans-latin-400italic-56bdf84751634e8deaff10d1d68df316.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:normal;font-weight:600;src:local("Open Sans SemiBold "),local("Open Sans-SemiBold"),url(/static/open-sans-latin-600-9526470852428b4340ed994462821463.woff2) format("woff2"),url(/static/open-sans-latin-600-7e06644bbdc83069cec8d396149da3ab.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:italic;font-weight:600;src:local("Open Sans SemiBold italic"),local("Open Sans-SemiBolditalic"),url(/static/open-sans-latin-600italic-cc4bf5b2955147801c024b2b118f4a5c.woff2) format("woff2"),url(/static/open-sans-latin-600italic-8d513ad94829ef391cd18d4a83bcfc4b.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:normal;font-weight:700;src:local("Open Sans Bold "),local("Open Sans-Bold"),url(/static/open-sans-latin-700-92425c623934facef057b0cfe2e13f95.woff2) format("woff2"),url(/static/open-sans-latin-700-f24f4bcef8a4a0eb6345d292b85dc7fe.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:italic;font-weight:700;src:local("Open Sans Bold italic"),local("Open Sans-Bolditalic"),url(/static/open-sans-latin-700italic-2a0783bd1c6c1469558bfa573cfa0c0c.woff2) format("woff2"),url(/static/open-sans-latin-700italic-e961bdb476db6860f20ff571a84a55b0.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:normal;font-weight:800;src:local("Open Sans ExtraBold "),local("Open Sans-ExtraBold"),url(/static/open-sans-latin-800-1666787ea3ff3941e7641817eb9edc94.woff2) format("woff2"),url(/static/open-sans-latin-800-8ab0bbdd48f276f4ba5652b27ae59210.woff) format("woff")}@font-face{font-display:swap;font-family:Open Sans;font-style:italic;font-weight:800;src:local("Open Sans ExtraBold italic"),local("Open Sans-ExtraBolditalic"),url(/static/open-sans-latin-800italic-b5bc26612cdf4d47affd6988bcdc8c0f.woff2) format("woff2"),url(/static/open-sans-latin-800italic-3d3bd0835c258f5bd0bce57bb1963a9c.woff) format("woff")}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}#___gatsby,#gatsby-focus-wrapper,body,html{height:100%}code[class*=language-],pre[class*=language-]{font-size:13px}blockquote{border-left:3px solid #ddd;font-style:italic;margin-left:0;padding-left:1rem}.gatsby-highlight{margin-bottom:1.5rem}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=f7bf0777384d9abebe3b16718e63334d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=f7bf0777384d9abebe3b16718e63334d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=f7bf0777384d9abebe3b16718e63334d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=f7bf0777384d9abebe3b16718e63334d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=f7bf0777384d9abebe3b16718e63334d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=f7bf0777384d9abebe3b16718e63334d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=f7bf0777384d9abebe3b16718e63334d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=f7bf0777384d9abebe3b16718e63334d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=f7bf0777384d9abebe3b16718e63334d"/><title data-react-helmet="true">Structured search queries for web UIs, part 2: the grammar | jsh</title><link data-react-helmet="true" rel="preconnect" href="https://fonts.googleapis.com"/><link data-react-helmet="true" rel="preconnect" href="https://fonts.gstatic.com"/><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&amp;display=swap"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="display:flex;min-height:100%;flex-direction:column;margin-left:auto;margin-right:auto;max-width:54rem;padding:2.25rem 1.125rem"><header><h3 style="margin-top:0"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/">jsh</a></h3></header><main><article><header><h1 style="margin-top:1.5rem;margin-bottom:0">Structured search queries for web UIs, part 2: the grammar</h1><p style="font-size:0.87055rem;line-height:1.5rem;display:block;margin-bottom:1.5rem"><i>October 06, 2024</i></p></header><section><p>This is what we promised to do in part 1:</p>
<blockquote>
<p>A query language that lets us express key value pairs, binary expressions, grouping, etc., with discoverability in mind.</p>
</blockquote>
<p>But … how does one write a query language? Where do we even <em>begin?</em></p>
<p>Well, a while back I had the good fortune to stumble across <em><a href="https://craftinginterpreters.com/">Crafting Interpreters</a></em> by Bob Nystrom, which is a brilliant introduction to the world of grammars, parsers and winterpreters.<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> It gave me a good enough understanding of the moving parts to hack out something that worked.</p>
<h2>A query language like grammar used to make</h2>
<p>But — why write <em>another</em> query language? Surely something like <a href="https://lucene.apache.org/core/2_9_4/queryparsersyntax.html">Lucene syntax</a> or <a href="https://www.elastic.co/guide/en/kibana/current/kuery-query.html">KQL</a> will do for our purposes?</p>
<p>The problem with Lucene is discoverability, which we’d like for both the key and value part of our chips. Imagine we’re trying to discover which structured search fields are available — for example, the values logged in the namespace <code class="language-text">lambdaStats</code> when we’re grepping logs ingested via <a href="https://github.com/guardian/cloudwatch-logs-management">cloudwatch-log-management.</a> Lucene (and KQL) would have us type, for example, <code class="language-text">lambdaStats.memorySizeMax</code> for the key portion, but there’s no way of distinguishing between a query for the string <code class="language-text">lambdaStats.lambdaVersion</code> and the key-value pair <code class="language-text">lambdaStats.lambdaVersion:&lt;version></code> until you type the <code class="language-text">:</code> — and that ambiguity prevents a UI from confidently presenting a typeahead to the user until it’s too late.</p>
<p>One solution, borrowed from the Grid and Giant chip implementations, is to add a leading <code class="language-text">+</code> to our chip grammar: <code class="language-text">+lambdaStats.lambdaVersion:&lt;version></code>. We can then present typeahead suggestions for keys as soon as we see <code class="language-text">+</code>, and values once we see a following <code class="language-text">:</code>. The cost is an extra character in the query, and any associated time/clarity/usability penalty. That feels trivial to me for now, so let’s take this approach and see how we fare.<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup></p>
<p>The rest of the query language will be heavily inspired by Lucene, for now ignoring some of the more domain-specific parts (fuzzy or proximity searches, ranges etc.) to sidestep complexity that isn’t chip- or binary- related. We’ll build up a grammar using a simple notation similar to <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form">BNF</a>, again borrowed from Crafting Interpreters — <a href="https://craftinginterpreters.com/representing-code.html">here’s the chapter</a> if you’d like to understand how grammars might be represented in more detail. Example queries in our language might look like:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">pets                           // Simple string search
"The pet I'll never forget"    // Quoted strings for reserved characters and whitespace
pets AND (cats OR dogs)        // Binary expressions
+tag:pets                      // Searching for specific fields
+tag:pets AND (cats OR dogs)   // Combinations of the above</code></pre></div>
<p>All that’s left to do is give it a cheeky name. For now, I’ve taken to calling it chips query language 🍟, or CQL for short.<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup></p>
<h2>A grammar for CQL</h2>
<p>The first thing we can be sure of is that a query in our language is a list of expressions. We can write that as the rule:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">query             -> expr+</code></pre></div>
<p>As in regular expressions, the postfix <code class="language-text">+</code> denotes one-or-more of the previous symbol. In plain English, this rule states, “a <code class="language-text">query</code> symbol is made up of one or more <code class="language-text">expr</code> symbols.”</p>
<p>There are three sorts of <code class="language-text">expr</code>: a plain <code class="language-text">str</code> (unquoted and quoted, the latter to permit characters that would otherwise be reserved), a <code class="language-text">chip</code> (<code class="language-text">+key:value</code>), and a <code class="language-text">group</code> (parentheses around an <code class="language-text">expr</code>.) Following the convention of borrowing from regular expressions, we can use the pipe character to denote an “or” relationship, and express that as:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">expr              -> str | group | chip</code></pre></div>
<p>Hold on, though — all of the members of <code class="language-text">expr</code> can be combined with binary expressions. So our rule for binary expressions comes first, where a binary can be a single expression, or an expression and another binary, optionally joined with an operator:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">query             -> binary+
binary            -> expr (('AND' | 'OR')? binary)*
expr              -> str | group | chip</code></pre></div>
<p>There’s some new symbols to add to our notation here. The postfix <code class="language-text">*</code> denotes zero-or-more of the previous symbol. The brackets group a collection of symbols. Finally, the postfix <code class="language-text">?</code> denotes that the preceding rule is optional.</p>
<p>With this rule, <code class="language-text">str</code>, <code class="language-text">str AND group</code>, <code class="language-text">str AND (group OR chip)</code>, and <code class="language-text">str str str</code> etc. are all valid. As with Lucene, when there’s no explicit operator between expressions, we default to <code class="language-text">OR</code> — so <code class="language-text">str str</code> is interpreted as <code class="language-text">str OR str</code>.</p>
<p>For our next line, how do we unpack <code class="language-text">str | group | chip</code>? Well, <code class="language-text">str</code> is what we call a “terminal” — a symbol that represents a token. Tokens form the alphabet that makes up a grammar. So there’s no need to define <code class="language-text">str</code> in our notation.</p>
<p>Groups are simple to define — they’re any possible binary, wrapped in parenthesis:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">group             -> '(' binary ')'</code></pre></div>
<p>where the open and close brackets here are also terminal symbols, this time representing the literal characters <code class="language-text">(</code> and <code class="language-text">)</code>.</p>
<p>Finally, the <code class="language-text">chip</code> needs contain a key and a value, where both chip_key and chip_value are tokens, and chip_value is optional, to permit parsing our grammar when our query is not yet fully-formed:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">chip              -> chip_key chip_value?</code></pre></div>
<p>Which leaves us with a simple grammar:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">query             -> binary+
binary            -> expr ('AND' | 'OR' expr)*
expr              -> str | group | chip
group             -> '(' binary ')'
chip              -> chip_key chip_value?</code></pre></div>
<p>That’s it! We might find that this grammar needs a few tweaks for useability purposes when we come to implement our UI, but the above is a great place to start.</p>
<h2>Grammar in action</h2>
<p>To test the grammar, we can “play” it — beginning from the top, expand our symbols until we’re left with a set of tokens. For example, if we start with <code class="language-text">query</code>, always expand the leftmost symbol first, and make a few arbitrary choices, we can produce something like:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">query
binary+
expr 'AND' expr
str 'AND' expr
str 'AND' group
str 'AND' (binary)
str 'AND' (expr 'OR' expr)
str 'AND' (chip 'OR' expr)
str 'AND' ('+' str ':' str 'OR' str)</code></pre></div>
<p>which, were we to fill in the strings, might look like <code class="language-text">pets AND (+tag:cats OR feline)</code>, a valid sentence in this grammar.</p>
<p>Of course, this grammar isn’t doing any work for us — yet. We’ll need to parse it into a machine-readable form. In the next post we’ll write a program that does just that, using two techniques: <em>scanning</em>, to produce the tokens that comprise our grammar, and <em>parsing</em>, to apply the grammar to those tokens, and give us a useful structure (or an error message!) as a result.</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">Bob Nystrom is a serial language designer, pedagogical genius, and S-rank <a href="https://x.com/munificentbob?lang=en">twitter/mastodon</a> follow. I’ll lean heavily on what I learned from <em>Crafting Interpreters</em> for the parsing/interpreting parts of this series, and if you’d like to learn more on these topics, or indeed write your very own programming language, I can’t recommend that book highly enough.<a href="#fnref-1" class="footnote-backref">↩</a></li>
<li id="fn-2">There’s another cost here — although our grammar might look a lot like Lucene, using <code class="language-text">+</code> to start our chips clashes with <a href="https://lucene.apache.org/core/2_9_4/queryparsersyntax.html#:~:text=The%20%22%2B%22%20or%20required%20operator%20requires%20that%20the%20term%20after%20the%20%22%2B%22%20symbol%20exist%20somewhere%20in%20a%20the%20field%20of%20a%20single%20document.">Lucene’s ‘must’ operator</a>. So, were we to want to have our query language be a superset of Lucene’s, we’d need to have some other character for our typeahead.<a href="#fnref-2" class="footnote-backref">↩</a></li>
<li id="fn-3">Hm, there are a fair few things <a href="https://en.wikipedia.org/wiki/CQL">already called CQL</a>. Don’t worry, we can rename it when it gets big.<a href="#fnref-3" class="footnote-backref">↩</a></li>
</ol>
</div></section><hr style="margin-bottom:1.5rem"/></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/structured-search-ui-1/">← <!-- -->Structured search queries for web UIs, part 1: the dream</a></li><li><a rel="next" href="/structured-search-ui-3/">Structured search queries for web UIs, part 3: scanning<!-- --> →</a></li></ul></nav></main><footer style="margin-top:auto"><div style="display:flex;align-items:center;margin-top:1.5rem"><div data-gatsby-image-wrapper="" style="margin-right:0.75rem;margin-bottom:0;min-width:50px;border-radius:100%" class="gatsby-image-wrapper gatsby-image-wrapper-constrained"><div style="max-width:50px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg%20height=&#x27;50&#x27;%20width=&#x27;50&#x27;%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#282828;position:absolute;top:0;left:0;bottom:0;right:0"></div><picture><source type="image/webp" data-srcset="/static/8c486420c9f37beb177f816e3e972b25/68795/profile-pic.webp 13w,/static/8c486420c9f37beb177f816e3e972b25/2fa99/profile-pic.webp 25w,/static/8c486420c9f37beb177f816e3e972b25/dbc4a/profile-pic.webp 50w,/static/8c486420c9f37beb177f816e3e972b25/d8057/profile-pic.webp 100w" sizes="(min-width: 50px) 50px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="border-radius:50%;opacity:0" sizes="(min-width: 50px) 50px, 100vw" decoding="async" loading="lazy" data-src="/static/8c486420c9f37beb177f816e3e972b25/6ac16/profile-pic.jpg" data-srcset="/static/8c486420c9f37beb177f816e3e972b25/4b206/profile-pic.jpg 13w,/static/8c486420c9f37beb177f816e3e972b25/74ef0/profile-pic.jpg 25w,/static/8c486420c9f37beb177f816e3e972b25/6ac16/profile-pic.jpg 50w,/static/8c486420c9f37beb177f816e3e972b25/e07e1/profile-pic.jpg 100w" alt="Jonathon Herbert"/></picture><noscript><picture><source type="image/webp" srcSet="/static/8c486420c9f37beb177f816e3e972b25/68795/profile-pic.webp 13w,/static/8c486420c9f37beb177f816e3e972b25/2fa99/profile-pic.webp 25w,/static/8c486420c9f37beb177f816e3e972b25/dbc4a/profile-pic.webp 50w,/static/8c486420c9f37beb177f816e3e972b25/d8057/profile-pic.webp 100w" sizes="(min-width: 50px) 50px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="border-radius:50%;opacity:0" sizes="(min-width: 50px) 50px, 100vw" decoding="async" loading="lazy" src="/static/8c486420c9f37beb177f816e3e972b25/6ac16/profile-pic.jpg" srcSet="/static/8c486420c9f37beb177f816e3e972b25/4b206/profile-pic.jpg 13w,/static/8c486420c9f37beb177f816e3e972b25/74ef0/profile-pic.jpg 25w,/static/8c486420c9f37beb177f816e3e972b25/6ac16/profile-pic.jpg 50w,/static/8c486420c9f37beb177f816e3e972b25/e07e1/profile-pic.jpg 100w" alt="Jonathon Herbert"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><p style="margin-bottom:0;font-size:0.8em">Written by <strong>Jonathon Herbert</strong>.<!-- --> <!-- -->Follow him on<!-- --> <a href="https://twitter.com/js_herbert">Twitter</a>, or look upon his works on<!-- --> <a href="https://github.com/jonathonherbert">Github</a>.</p></div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/structured-search-ui-2/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-09402a4c01576a38cd5e.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-fe2ed841316dca0cad80.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-3954d1123bec1d58e166.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-028ece1662cef2778d03.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="e7fd022457814554d2e3";</script><script src="/webpack-runtime-5f49dcce5003192bed76.js" async></script><script src="/framework-e0e5fad7f961d61cb6c1.js" async></script><script src="/app-09402a4c01576a38cd5e.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>